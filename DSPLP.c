#include "dsk6713_led.h"
#include "dsk6713_dip.h"

#include "dsk6713.h"
#include "dsk6713_aic23.h"

#define FILTER_TAP_NUM 124


float filter_Coeff_1[] =  {
		   0.004037831632915,  0.00438865979705,  0.00461957569514, 0.004709634449017,
		   0.004644290963298, 0.004416824236283, 0.004029377542487, 0.003493517512426,
		   0.002830238892618, 0.002069371785052, 0.001248382916657,0.0004106000675691,
		  -0.0003970729984248,-0.001126847256856,-0.001733008536741, -0.00217498467204,
		  -0.002420339541541,-0.002447505913898,-0.002248071981939,-0.001828450770478,
		  -0.001210787000478,-0.0004329915744853,0.0004521619573644, 0.001378893946367,
		   0.002271188757043, 0.003046383735796,  0.00361942945345, 0.003907626325005,
		   0.003835603963079, 0.003340282077761, 0.002375537495297,0.0009163023529891,
		  -0.001038165626976,-0.003462068893055,-0.006302094911185,-0.009477805984877,
		   -0.01288345329579, -0.01639120162882, -0.01985567607944, -0.02311966851741,
		   -0.02602077376596, -0.02839866722748,  -0.0301026905159, -0.03099938239412,
		   -0.03097958102676, -0.02996473138283,  -0.0279120586882, -0.02481831422344,
		   -0.02072186156579, -0.01570294673302,-0.009882080963985,-0.003416555819042,
		   0.003504797721458,  0.01066840620726,  0.01784402685147,  0.02479374970397,
		    0.03128153073968,  0.03708282589412,  0.04199388524542,  0.04584027749642,
		    0.04848424729428,  0.04983056025074,  0.04983056025074,  0.04848424729428,
		    0.04584027749642,  0.04199388524542,  0.03708282589412,  0.03128153073968,
		    0.02479374970397,  0.01784402685147,  0.01066840620726, 0.003504797721458,
		  -0.003416555819042,-0.009882080963985, -0.01570294673302, -0.02072186156579,
		   -0.02481831422344,  -0.0279120586882, -0.02996473138283, -0.03097958102676,
		   -0.03099938239412,  -0.0301026905159, -0.02839866722748, -0.02602077376596,
		   -0.02311966851741, -0.01985567607944, -0.01639120162882, -0.01288345329579,
		  -0.009477805984877,-0.006302094911185,-0.003462068893055,-0.001038165626976,
		  0.0009163023529891, 0.002375537495297, 0.003340282077761, 0.003835603963079,
		   0.003907626325005,  0.00361942945345, 0.003046383735796, 0.002271188757043,
		   0.001378893946367,0.0004521619573644,-0.0004329915744853,-0.001210787000478,
		  -0.001828450770478,-0.002248071981939,-0.002447505913898,-0.002420339541541,
		   -0.00217498467204,-0.001733008536741,-0.001126847256856,-0.0003970729984248,
		  0.0004106000675691, 0.001248382916657, 0.002069371785052, 0.002830238892618,
		   0.003493517512426, 0.004029377542487, 0.004416824236283, 0.004644290963298,
		   0.004709634449017,  0.00461957569514,  0.00438865979705, 0.004037831632915
		};


float filter_Coeff_2[] =   {
		3.4941E-03,4.5441E-03,3.3446E-03,6.4897E-04,-1.9776E-03,-3.1377E-03,
		-2.4795E-03,-8.7716E-04,2.4252E-04,-4.9411E-19,-1.1834E-03,-1.7843E-03,
		-3.1449E-04,3.3149E-03,7.2087E-03,8.3078E-03,4.3488E-03,-4.1791E-03,
		-1.3466E-02,-1.7935E-02,-1.3383E-02,5.4559E-17,1.6684E-02,2.7941E-02,
		2.6349E-02,1.0356E-02,-1.3813E-02,-3.4424E-02,-3.9973E-02,-2.5567E-02,
		3.5917E-03,3.3896E-02,4.9796E-02,4.1909E-02,1.2484E-02,-2.4953E-02,
		-5.1962E-02,-5.4501E-02,-3.0380E-02,9.1899E-03,4.4948E-02,5.9232E-02,
		4.4948E-02,9.1899E-03,-3.0380E-02,-5.4501E-02,-5.1962E-02,-2.4953E-02,
		1.2484E-02,4.1909E-02,4.9796E-02,3.3896E-02,3.5917E-03,-2.5567E-02,
		-3.9973E-02,-3.4424E-02,-1.3813E-02,1.0356E-02,2.6349E-02,2.7941E-02,
		1.6684E-02,5.4559E-17,-1.3383E-02,-1.7935E-02,-1.3466E-02,-4.1791E-03,
		4.3488E-03,8.3078E-03,7.2087E-03,3.3149E-03,-3.1449E-04,-1.7843E-03,
		-1.1834E-03,-4.9411E-19,2.4252E-04,-8.7716E-04,-2.4795E-03,-3.1377E-03,
		-1.9776E-03,6.4897E-04,3.3446E-03,4.5441E-03,3.4941E-03
		};


static short in_buffer[200];


DSK6713_AIC23_Config config = { \
    0x0017,  /* 0 DSK6713_AIC23_LEFTINVOL  Left line input channel volume */ \
    0x0017,  /* 1 DSK6713_AIC23_RIGHTINVOL Right line input channel volume */\
    0x00d8,  /* 2 DSK6713_AIC23_LEFTHPVOL  Left channel headphone volume */  \
    0x00d8,  /* 3 DSK6713_AIC23_RIGHTHPVOL Right channel headphone volume */ \
    0x0011,  /* 4 DSK6713_AIC23_ANAPATH    Analog audio path control */      \
    0x0000,  /* 5 DSK6713_AIC23_DIGPATH    Digital audio path control */     \
    0x0000,  /* 6 DSK6713_AIC23_POWERDOWN  Power down control */             \
    0x0043,  /* 7 DSK6713_AIC23_DIGIF      Digital audio interface format */ \
    0x0081,  /* 8 DSK6713_AIC23_SAMPLERATE Sample rate control */            \
    0x0001   /* 9 DSK6713_AIC23_DIGACT     Digital interface activation */   \
};


/*
 *  main() - Main code routine, initializes BSL and generates tone
 */

void main()
{
	DSK6713_init();                  // to initiate the led function
	DSK6713_LED_init();
    DSK6713_AIC23_CodecHandle hCodec;

    Uint32 l_input, r_input,l_output_1, l_output_2, l_output, r_output;

    /* Initialize the board support library, must be called first */
    DSK6713_init();

    /* Start the codec */
    hCodec = DSK6713_AIC23_openCodec(0, &config);

    DSK6713_AIC23_setFreq(hCodec, 1);

       while(1)
        {	/* Read a sample to the left channel */
			while (!DSK6713_AIC23_read(hCodec, &l_input));

			/* Read a sample to the right channel */
			while (!DSK6713_AIC23_read(hCodec, &r_input));

				l_output_1=(Int16)FIR_FILTER_1(&filter_Coeff_1, l_input);

				if(l_output_1>4294966600){
					DSK6713_LED_on(0);
				}
				else{
					DSK6713_LED_off(0);
				}

				l_output_2=(Int16)FIR_FILTER_2(&filter_Coeff_2, l_input);

				if(l_output_2>4294966600){
				DSK6713_LED_on(3);
				}
				else{
				DSK6713_LED_off(3);
				}

				if(l_output_1 < 4294966600){
					l_output = l_output_1;
				}
				else{
					l_output = l_output_2;
				}

				r_output=l_output;

			while (!DSK6713_AIC23_write(hCodec, l_output));
            while (!DSK6713_AIC23_write(hCodec, r_output));
        }
    DSK6713_AIC23_closeCodec(hCodec);
}


signed int FIR_FILTER_1(float * h, signed int x)
{
int i=0;
signed long output=0;

in_buffer[0] = x;  /* new input at buffer[0]  */

for(i=124;i>0;i--)
in_buffer[i] = in_buffer[i-1]; /* shuffle the buffer   */

for(i=0;i<124;i++)
output = output + h[i] * in_buffer[i];

return(output);
}

signed int FIR_FILTER_2(float * j, signed int y)
{
int i=0;
signed long output=0;

in_buffer[0] = y;  /*new input at buffer[0]*/

for(i=83;i>0;i--)
in_buffer[i] = in_buffer[i-1]; /*shuffle the buffer*/

for(i=0;i<83;i++)
output = output + j[i] * in_buffer[i];

return(output);

}

